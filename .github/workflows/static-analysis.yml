name: 'Static Analysis'

on:
  workflow_call:

jobs:
  static-analysis-run:
    name: 'Static Analysis (PHPStan, PHPMD, PHPCS, Rector)'
    runs-on: [self-hosted, dind]
    container:
        image: php:8.2-cli
    steps:
      - run: |
          echo "PHP Version: $(php -v)"

      - run: |
          ls -la
          ls -la vendor || true

      - name: Run phpcs
        run: ./vendor/bin/phpcs -q -s --standard=./phpcs.xml ./src --report=full --exclude=Generic.Files.LineLength
        continue-on-error: true

      - name: Run phpcs (Full)
        run: ./vendor/bin/phpcs -q -s --standard=./phpcs.xml ./src --report=full --ignore-annotations
        if: always()
        continue-on-error: true

      - name: Run phpmd
        run: ./vendor/bin/phpmd --strict --color ./src text ./phpmd.xml
        if: always()
        continue-on-error: true

      - name: Run phpstan
        run: ./vendor/bin/phpstan --configuration=./phpstan.neon analyse ./src --level 8 --error-format=table
        if: always()
        continue-on-error: true

      - name: Run psalm
        run: php ./psalm.phar --config=psalm.xml --output-format=compact --generate-json-map=psalm-output.json
        if: always()
        continue-on-error: true

      - name: Run rector
        run: ./vendor/bin/rector --config=./rector.php process ./src --dry-run
        if: always()
        continue-on-error: true

      - name: Run composer-normalize
        run: composer normalize
        if: always()
        continue-on-error: true

  checkout:
    name: 'Checkout'
    runs-on: self-hosted
    needs: static-analysis-run
    if: always()
    steps:
      - uses: actions/checkout@v4
      - run: |
          echo "Checkout"
          ls -la