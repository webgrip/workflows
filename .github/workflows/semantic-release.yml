name: 'Semantic Release'

on:
  workflow_call:
    inputs:
      release-type:
        description: 'The type of release'
        required: false
        type: string
      use-bot-to-commit:
        description: 'Whether to use the GitHub App bot to commit changes'
        required: false
        default: false
        type: boolean
    secrets:
      WEBGRIP_CI_APP_ID:
        description: 'GitHub App ID (numeric)'
        required: false
      WEBGRIP_CI_APP_PRIVATE_KEY:
        description: 'GitHub App private key'
        required: false
    outputs:
      version:
        description: 'The new version number'
        value: ${{ jobs.semantic-release.outputs.version }}

jobs:
  semantic-release:
    name: 'Semantic Release'
    runs-on: arc-runner-set
    permissions:
      contents: write # For pushing commits/tags
      pull-requests: write # If referencing or updating PRs
      issues: write # Needed to comment on issues/PRs
      statuses: write # (Optional) If you need to set commit statuses
    outputs:
      version: ${{ steps.semantic-release.outputs.version }}
    steps:
      - name: Mint GitHub App token
        id: app-token
        if: ${{ inputs.use-bot-to-commit }}
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.WEBGRIP_CI_APP_ID }}
          private-key: ${{ secrets.WEBGRIP_CI_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}

      - name: Resolve bot noreply email
        id: bot-email
        if: ${{ inputs.use-bot-to-commit }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const slug = ${{ vars.WEBGRIP_CI_BOT_NAME }} || 'webgrip-ci';
            const username = `${slug}[bot]`;
            try {
              const { data: user } = await github.request('GET /users/{username}', { username });
              core.setOutput('name', username);
              core.setOutput('email', `${user.id}+${username}@users.noreply.github.com`);
            } catch {
              core.setOutput('name', 'github-actions[bot]');
              core.setOutput('email', '41898282+github-actions[bot]@users.noreply.github.com');
            }

      - name: Authenticate git remote for push
        if: ${{ inputs.use-bot-to-commit }}
        env:
          APP_TOKEN: ${{ steps.app-token.outputs.token }}
          ORG: ${{ github.repository_owner }}
          NEW_REPO: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail
          git remote set-url origin "https://x-access-token:${APP_TOKEN}@github.com/${ORG}/${NEW_REPO}.git"

      - id: semantic-release
        uses: webgrip/workflows/.github/composite-actions/semantic-release@main
        with:
          release-type: ${{ inputs.release-type }}
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
